<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Astro Dashboard — DWARF 3</title>
  <style>
    body { background:#0a0f25; color:white; font-family:sans-serif; margin:20px; }
    h1 { color:#9fd1ff; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { padding:8px 12px; border:1px solid #333; text-align:left; }
    th { background:#1c274d; color:#9fd1ff; }
    tr:nth-child(even) { background:#141a33; }
    tr:nth-child(odd) { background:#1a2140; }
    .total-row { background:#233366; font-weight:bold; }
    .warning { color:#ff5555; font-weight:bold; padding:15px; }
  </style>
</head>
<body>
  <h1>Astro Dashboard — DWARF 3</h1>
  <div id="content">Caricamento dati...</div>

  <script>
    function formatTimeHM(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      return `${h}h ${m}m`;
    }

    async function loadLibrary() {
      const url = "https://raw.githubusercontent.com/xelmo76/dwarf-astro-library/main/libreria.json";
      try {
        const res = await fetch(url + "?t=" + Date.now()); // evita cache
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        if (Object.keys(data).length === 0) {
          document.getElementById('content').innerHTML =
            "<div class='warning'>⚠ Nessun dato presente in libreria.json</div>";
          return;
        }

        let html = "<table><tr><th>Target</th><th>Exp/Gain</th><th>Frames</th><th>Integrazione (s)</th><th>Integrazione (h:m)</th><th>Ultimo aggiornamento</th></tr>";

        for (const target in data) {
          let totalFrames = 0;
          let totalSeconds = 0;
          let lastUpdated = "";

          for (const combo in data[target]) {
            const entry = data[target][combo];
            totalFrames += entry.frames;
            totalSeconds += entry.integration_seconds;
            lastUpdated = entry.last_updated;

            html += `<tr>
                      <td>${target}</td>
                      <td>${combo}</td>
                      <td>${entry.frames}</td>
                      <td>${entry.integration_seconds}</td>
                      <td>${formatTimeHM(entry.integration_seconds)}</td>
                      <td>${entry.last_updated}</td>
                    </tr>`;
          }

          const totalFormatted = formatTimeHM(totalSeconds);
          html += `<tr class="total-row">
                    <td>${target}</td>
                    <td>TOTALE</td>
                    <td>${totalFrames}</td>
                    <td>${totalSeconds}</td>
                    <td>${totalFormatted}</td>
                    <td>${lastUpdated}</td>
                  </tr>`;
        }

        html += "</table>";
        document.getElementById('content').innerHTML = html;
      } catch(e) {
        document.getElementById('content').innerHTML =
          "<div class='warning'>Errore nel caricamento: " + e + "</div>";
      }
    }
    loadLibrary();
  </script>
</body>
</html>
