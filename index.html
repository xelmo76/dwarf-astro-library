<!doctype html>
<html lang="it" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DWARF 3 — Libreria Astrofotografia</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"/>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

    <style>
      :root {
        --bg-body: #0b0e14;
        --bg-card: #121825;
        --text-main: #e6eefc;
        --text-dim: #a7b3c4;
        --accent: #87b0ff;
        --border-subtle: rgba(255,255,255,0.06);
      }
      body { background: radial-gradient(1200px 800px at 80% -10%, #11192a 0%, #0b0e14 60%, #0b0e14 100%); color: var(--text-main); }
      .navbar { background: linear-gradient(180deg, rgba(18,24,37,0.9), rgba(18,24,37,0.6)); border-bottom: 1px solid var(--border-subtle); }
      .card { background-color: var(--bg-card); border: 1px solid var(--border-subtle); box-shadow: 0 6px 18px rgba(0,0,0,0.35); }
      .summary-chip { display:inline-flex; align-items:center; gap:.5rem; padding:.4rem .75rem; border-radius:999px; background:rgba(135,176,255,.12); border:1px solid rgba(135,176,255,.25); color:#cfe0ff; font-weight:600; }
      .muted { color: var(--text-dim); }
      .chart-wrap { position: relative; width: 100%; height: 220px; }
      @media (min-width: 992px) { .chart-wrap { height: 240px; } }
      .list-inline { margin:0; padding:0; list-style:none; }
      .list-inline li { display:flex; justify-content:space-between; gap:1rem; padding:.4rem .6rem; border-radius:.5rem; border:1px solid var(--border-subtle); background:rgba(255,255,255,0.02); }
      .badge-exp { background:rgba(135,176,255,0.15); color:#d5e4ff; border:1px solid rgba(135,176,255,0.25) }
      .badge-gain { background:rgba(255,255,255,0.06); color:#dbe6ff; border:1px solid var(--border-subtle) }
      .empty { border:1px dashed var(--border-subtle); background:rgba(255,255,255,0.02); }
    </style>
  </head>
  <body>
    <nav class="navbar sticky-top">
      <div class="container py-2 d-flex justify-content-between">
        <span class="fs-4 fw-semibold">DWARF 3 · Libreria Astrofotografia</span>
        <div class="d-flex gap-2">
          <span id="lastUpdated" class="badge text-bg-dark border">Aggiornamento…</span>
          <button id="btnRefresh" class="btn btn-sm btn-outline-light">Aggiorna dati</button>
        </div>
      </div>
    </nav>

    <main class="container my-4">
      <section id="summary" class="mb-4">
        <div class="card"><div class="card-body d-flex justify-content-between flex-wrap gap-3">
          <div>
            <h1 class="h4 mb-1">Riepilogo libreria</h1>
            <div class="muted">Stato attuale della cartella <code>DWARF_Library</code>.</div>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <div class="summary-chip"><span id="sumFrames">—</span> frames</div>
            <div class="summary-chip"><span id="sumIntegration">—</span></div>
          </div>
        </div></div>
      </section>

      <div id="emptyState" class="d-none">
        <div class="card empty"><div class="card-body">
          <h2 class="h5">Libreria vuota</h2>
          <p class="mb-0">Nessun target disponibile. Quando <code>libreria.json</code> è <code>{}</code> o la cartella è vuota, vedrai questo messaggio.</p>
        </div></div>
      </div>

      <section id="cards" class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4"></section>
    </main>

    <template id="cardTemplate">
      <div class="col">
        <div class="card h-100">
          <div class="card-body d-flex flex-column gap-2">
            <div class="d-flex justify-content-between">
              <h3 class="card-title h5 mb-0 target-name"></h3>
              <span class="badge rounded-pill text-bg-secondary target-total">—</span>
            </div>
            <div class="chart-wrap"><canvas></canvas></div>
            <ul class="list-inline d-flex flex-column gap-2 combos"></ul>
          </div>
        </div>
      </div>
    </template>

    <script>
      const KNOWN_META_KEYS = new Set(['last_updated','lastUpdated','library_total_frames','library_total_integration_s','total_frames','integrazione','version']);
      const qs = (sel, el=document) => el.querySelector(sel);

      function humanDuration(s){s=Math.max(0,Math.round(s||0));const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;const p=[];if(h)p.push(`${h}h`);if(m||(!h&&!sec))p.push(`${m}m`);if(sec&&!h)p.push(`${sec}s`);return p.join(' ');}
      function formatNumber(n){return new Intl.NumberFormat('it-IT').format(n);}
      function pickColors(n){const c=[];for(let i=0;i<n;i++){const hue=Math.round((i*137.508)%360);c.push(`hsl(${hue} 70% 60% / 0.85)`);}return c;}

      function normalizeLibrary(raw){
        if(!raw||typeof raw!=="object") return {lastUpdated:undefined,targets:[]};
        if(Object.keys(raw).length===0) return {lastUpdated:undefined,targets:[]};
        const lastUpdated=raw.last_updated||raw.lastUpdated||raw.updated_at;
        const targets=[];
        const container={};
        for(const[k,v] of Object.entries(raw)) if(!KNOWN_META_KEYS.has(k)) container[k]=v;
        const asArray=Object.entries(container).map(([name,node])=>({name,...node}));
        for(const item of asArray){
          const name=item.name||"Senza nome";
          const combos=[];
          for(const [key,val] of Object.entries(item)){
            if(['name','target','id','total_frames','total_integration_s','combos'].includes(key)) continue;
            const m=String(key).match(/(\d+(?:\.\d+)?)\s*s?\D+(\d+)/i)||String(key).match(/exp\s*(\d+(?:\.\d+)?)\D+gain\s*(\d+)/i);
            const exp=m?Number(m[1]):Number(val.exp||val.exposure||0);
            const gain=m?Number(m[2]):Number(val.gain||0);
            const frames=Number(val.frames||val.count||0);
            let integ=Number(val.integration_s||val.integration||val.integration_seconds||0);
            if(!integ&&exp&&frames) integ=exp*frames;
            if(frames>0 || integ>0) combos.push({exp,gain,frames,integration_s:integ});
          }
          const total_frames=combos.reduce((a,c)=>a+c.frames,0);
          const total_integration_s=combos.reduce((a,c)=>a+c.integration_s,0);
          if(combos.length) targets.push({name,combos,total_frames,total_integration_s});
        }
        return {lastUpdated,targets};
      }

      function buildCardSkeleton(t){
        const tpl=qs('#cardTemplate');
        const node=tpl.content.cloneNode(true);
        qs('.target-name',node).textContent=t.name;
        qs('.target-total',node).textContent=`${formatNumber(t.total_frames)} fr · ${humanDuration(t.total_integration_s)}`;
        const ul=qs('.combos',node);
        for(const c of t.combos.sort((a,b)=>a.exp-b.exp||a.gain-b.gain)){
          const li=document.createElement('li');
          li.innerHTML=`<div class="d-flex gap-2"><span class="badge badge-exp">${c.exp}s</span><span class="badge badge-gain">GAIN ${c.gain}</span></div><div class="text-end small"><div><strong>${formatNumber(c.frames)}</strong> frames</div><div class="muted">${humanDuration(c.integration_s)}</div></div>`;
          ul.appendChild(li);
        }
        return node;
      }

      function initChartForCard(cardRoot,t){
        const byExp=new Map();
        for(const c of t.combos){ const key=`${c.exp}s`; byExp.set(key,(byExp.get(key)||0)+c.frames); }
        const labels=[...byExp.keys()], data=[...byExp.values()], colors=pickColors(labels.length);
        const canvas=cardRoot.querySelector('canvas');
        if(!canvas) return; // safety
        new Chart(canvas.getContext('2d'),{type:'pie',data:{labels,datasets:[{data,backgroundColor:colors}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:12}},tooltip:{callbacks:{label:(ctx)=>{const v=ctx.raw||0,total=data.reduce((a,b)=>a+b,0)||1,pct=Math.round((v/total)*100);return `${ctx.label}: ${formatNumber(v)} fr (${pct}%)`;}}}}}});
      }

      async function loadLibrary(){
        const res=await fetch(`libreria.json?ts=${Date.now()}`,{cache:'no-store'});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      }

      function updateLastUpdated(ts){const el=qs('#lastUpdated');if(!ts){el.textContent='Ultimo aggiornamento: sconosciuto';return;}try{const d=new Date(ts);el.textContent=`Ultimo aggiornamento: ${d.toLocaleString('it-IT')}`;}catch{el.textContent=`Ultimo aggiornamento: ${ts}`;}}

      function render({lastUpdated,targets}){
        updateLastUpdated(lastUpdated);
        const cards=qs('#cards');cards.innerHTML='';
        if(!targets.length){qs('#emptyState').classList.remove('d-none');qs('#sumFrames').textContent='0';qs('#sumIntegration').textContent='0m';return;}
        qs('#emptyState').classList.add('d-none');
        let sumF=0,sumI=0;for(const t of targets){sumF+=t.total_frames;sumI+=t.total_integration_s;const frag=buildCardSkeleton(t);const wrapper=document.createElement('div');wrapper.appendChild(frag);const cardRoot=wrapper.firstElementChild;cards.appendChild(cardRoot);requestAnimationFrame(()=>initChartForCard(cardRoot,t));}
        qs('#sumFrames').textContent=formatNumber(sumF);
        qs('#sumIntegration').textContent=humanDuration(sumI);
      }

      async function init(){
        try{ const raw=await loadLibrary(); const norm=normalizeLibrary(raw); render(norm); }
        catch(e){ console.error(e); updateLastUpdated(); qs('#emptyState').classList.remove('d-none'); qs('#cards').innerHTML=''; }
      }
      init();
      qs('#btnRefresh').addEventListener('click',init);
    </script>
  </body>
</html>
