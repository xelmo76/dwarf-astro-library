<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Astro Dashboard — DWARF 3</title>
  <style>
    body { background:#0a0f25; color:white; font-family:sans-serif; margin:20px; }
    h1 { color:#9fd1ff; }
    select { padding:8px; margin:10px 0; font-size:1em; }
    .warning { color:#ff5555; font-weight:bold; padding:15px; }

    /* Stile tabella desktop */
    .table-container { overflow-x:auto; margin-top:15px; }
    table { width:100%; border-collapse:collapse; min-width:600px; }
    th, td { padding:8px 12px; border:1px solid #333; text-align:left; }
    th { background:#1c274d; color:#9fd1ff; }
    tr:nth-child(even) { background:#141a33; }
    tr:nth-child(odd) { background:#1a2140; }
    .total-row { background:#233366; font-weight:bold; }

    /* Layout card per mobile */
    @media (max-width: 768px) {
      table { display:none; } /* nasconde tabella su mobile */
      .card { background:#141a33; padding:15px; border-radius:8px; margin:10px 0; }
      .card h2 { margin:0 0 10px 0; color:#9fd1ff; }
      .combo { margin-left:15px; }
      .combo p { margin:3px 0; }
    }
  </style>
</head>
<body>
  <h1>Astro Dashboard — DWARF 3</h1>
  <label for="targetSelect">Scegli un target:</label>
  <select id="targetSelect">
    <option value="ALL">Tutti</option>
  </select>
  <div id="content">Caricamento dati...</div>

  <script>
    function formatTimeHM(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      return `${h}h ${m}m`;
    }

    let globalData = {};

    function renderTable(selectedTarget) {
      if (Object.keys(globalData).length === 0) {
        document.getElementById('content').innerHTML =
          "<div class='warning'>⚠ Nessun dato presente in libreria.json</div>";
        return;
      }

      // --- Vista desktop: tabella ---
      let html = '<div class="table-container"><table><tr><th>Target</th><th>Exp/Gain</th><th>Frames</th><th>Integrazione (s)</th><th>Integrazione (h:m)</th><th>Ultimo aggiornamento</th></tr>';

      for (const target in globalData) {
        if (selectedTarget !== "ALL" && target !== selectedTarget) continue;

        let totalFrames = 0;
        let totalSeconds = 0;
        let lastUpdated = "";

        for (const combo in globalData[target]) {
          const entry = globalData[target][combo];
          totalFrames += entry.frames;
          totalSeconds += entry.integration_seconds;
          lastUpdated = entry.last_updated;

          html += `<tr>
                    <td>${target}</td>
                    <td>${combo}</td>
                    <td>${entry.frames}</td>
                    <td>${entry.integration_seconds}</td>
                    <td>${formatTimeHM(entry.integration_seconds)}</td>
                    <td>${entry.last_updated}</td>
                  </tr>`;
        }

        const totalFormatted = formatTimeHM(totalSeconds);
        html += `<tr class="total-row">
                  <td>${target}</td>
                  <td>TOTALE</td>
                  <td>${totalFrames}</td>
                  <td>${totalSeconds}</td>
                  <td>${totalFormatted}</td>
                  <td>${lastUpdated}</td>
                </tr>`;
      }

      html += "</table></div>";

      // --- Vista mobile: cards ---
      html += `<div id="cards">`;
      for (const target in globalData) {
        if (selectedTarget !== "ALL" && target !== selectedTarget) continue;

        let totalFrames = 0;
        let totalSeconds = 0;
        let lastUpdated = "";

        let combosHTML = "";
        for (const combo in globalData[target]) {
          const entry = globalData[target][combo];
          totalFrames += entry.frames;
          totalSeconds += entry.integration_seconds;
          lastUpdated = entry.last_updated;

          combosHTML += `
            <div class="combo">
              <p><b>${combo}</b> — ${entry.frames} frames, ${entry.integration_seconds}s (${formatTimeHM(entry.integration_seconds)})</p>
            </div>`;
        }

        const totalFormatted = formatTimeHM(totalSeconds);
        html += `
          <div class="card">
            <h2>${target}</h2>
            ${combosHTML}
            <p><b>Totale:</b> ${totalFrames} frames, ${totalSeconds}s (${totalFormatted})</p>
            <p><i>Aggiornato: ${lastUpdated}</i></p>
          </div>`;
      }
      html += `</div>`;

      document.getElementById('content').innerHTML = html;
    }

    async function loadLibrary() {
      const url = "https://raw.githubusercontent.com/xelmo76/dwarf-astro-library/main/libreria.json";
      try {
        const res = await fetch(url + "?t=" + Date.now());
        if (!res.ok) throw new Error("HTTP " + res.status);
        globalData = await res.json();

        const select = document.getElementById('targetSelect');
        for (const target in globalData) {
          const opt = document.createElement("option");
          opt.value = target;
          opt.textContent = target;
          select.appendChild(opt);
        }

        renderTable("ALL");
        select.addEventListener("change", () => {
          renderTable(select.value);
        });

      } catch(e) {
        document.getElementById('content').innerHTML =
          "<div class='warning'>Errore nel caricamento: " + e + "</div>";
      }
    }
    loadLibrary();
  </script>
</body>
</html>
